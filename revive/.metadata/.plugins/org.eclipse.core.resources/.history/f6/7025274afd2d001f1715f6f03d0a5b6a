package com.smhrd.member.controller;

import java.io.IOException;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

public class MemberEditCon extends HttpServlet {
    private static final long serialVersionUID = 1L;

    protected void service(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        System.out.println("Member Edit Controller!");
        // 1. 한글 인코딩 설정
        request.setCharacterEncoding("UTF-8");

        // 2. 데이터 가져오기
        String mem_id = request.getParameter("id");
        String mem_pw = request.getParameter("pw");
        String mem_pw_new = request.getParameter("pw_new");
        String mem_name = request.getParameter("name");
        String mem_phone = request.getParameter("phone");
        String mem_mail = request.getParameter("mail");

        // 세션에서 로그인된 회원 정보 가져오기
        HttpSession session = request.getSession();
        MemberDTO loginMember = (MemberDTO) session.getAttribute("loginMember");

        if (loginMember != null) {
            // 현재 로그인된 회원의 비밀번호 확인
            String currentPw = loginMember.getMem_pw();

            // 비밀번호 변경 시, 현재 비밀번호와 새 비밀번호가 일치하는지 확인
            if (mem_pw.equals(currentPw) && !mem_pw.equals(mem_pw_new)) {
                // 비밀번호 변경 로직 수행
                // 예시: DAO를 통해 비밀번호 업데이트 처리
                MemberDAO dao = new MemberDAO();
                boolean isSuccess = dao.updatePassword(mem_id, mem_pw_new);

                if (isSuccess) {
                    // 비밀번호 변경 성공 시 세션에 업데이트된 회원 정보 저장
                    loginMember.setMem_pw(mem_pw_new);
                    session.setAttribute("loginMember", loginMember);

                    // 변경 성공 메시지 설정 후 페이지 이동
                    request.setAttribute("message", "비밀번호가 성공적으로 변경되었습니다.");
                    request.getRequestDispatcher("edit_complete.jsp").forward(request, response);
                } else {
                    // 비밀번호 변경 실패 시 메시지 설정 후 이전 페이지로 이동
                    request.setAttribute("error", "비밀번호 변경에 실패했습니다. 다시 시도해주세요.");
                    request.getRequestDispatcher("edit_form.jsp").forward(request, response);
                }
            } else {
                // 현재 비밀번호가 일치하지 않거나 새 비밀번호와 같은 경우 처리
                request.setAttribute("error", "현재 비밀번호가 일치하지 않거나 새 비밀번호가 기존과 동일합니다.");
                request.getRequestDispatcher("edit_form.jsp").forward(request, response);
            }
        } else {
            // 세션이 없거나 로그인되지 않은 경우 처리
            response.sendRedirect("login.html");
        }
    }
}
